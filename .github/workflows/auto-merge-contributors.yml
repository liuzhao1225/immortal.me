name: Auto-merge contributor PRs

on:
  pull_request_target:
    branches: [main]
    paths:
      - 'contributors/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login != github.repository_owner
    steps:
      - name: Check and auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO: ${{ github.repository }}
        run: |
          ALLOWED="contributors/${PR_AUTHOR}/"
          ALL_MINE=true

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            if [[ "$file" != ${ALLOWED}* ]]; then
              ALL_MINE=false
              break
            fi
          done <<< "$(gh pr diff "$PR_NUMBER" -R "$REPO" --name-only)"

          if [ "$ALL_MINE" = false ]; then
            echo "PR contains changes outside ${ALLOWED} â€” skip auto-merge, leave open for manual review"
            exit 0
          fi

          gh pr review "$PR_NUMBER" -R "$REPO" --approve \
            -b "Auto-approved: all changes within ${ALLOWED}"
          gh pr merge "$PR_NUMBER" -R "$REPO" --squash --auto
