name: Auto-merge contributor PRs

on:
  pull_request_target:
    branches: [main]
    paths:
      - 'contributors/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login != github.repository_owner
    steps:
      - name: Validate and auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO: ${{ github.repository }}
        run: |
          ALLOWED="contributors/${PR_AUTHOR}/"

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            if [[ "$file" != ${ALLOWED}* ]]; then
              echo "::error::Unauthorized change: $file"
              exit 1
            fi
          done <<< "$(gh pr diff "$PR_NUMBER" -R "$REPO" --name-only)"

          gh pr review "$PR_NUMBER" -R "$REPO" --approve \
            -b "Auto-approved: all changes within ${ALLOWED}"
          gh pr merge "$PR_NUMBER" -R "$REPO" --squash --auto
