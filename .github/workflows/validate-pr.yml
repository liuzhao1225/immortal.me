name: Validate PR

on:
  pull_request_target:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-permission:
    runs-on: ubuntu-latest
    steps:
      - name: Validate changed files
        id: validate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO_OWNER: ${{ github.repository_owner }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          if [ "$PR_AUTHOR" = "$REPO_OWNER" ]; then
            echo "Repo owner (${PR_AUTHOR}) — skip check"
            exit 0
          fi

          ALLOWED="contributors/${PR_AUTHOR}/"
          CHANGED=$(gh pr diff "$PR_NUMBER" -R "$REPO" --name-only)

          echo "PR author: ${PR_AUTHOR}"
          echo "Allowed prefix: ${ALLOWED}"
          echo "Changed files:"
          echo "${CHANGED}"

          VIOLATIONS=""
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            if [[ "$file" != ${ALLOWED}* ]]; then
              VIOLATIONS="${VIOLATIONS}\n  - ${file}"
            fi
          done <<< "$CHANGED"

          if [ -n "$VIOLATIONS" ]; then
            echo "::error::You can only modify files in ${ALLOWED}"
            echo -e "Unauthorized changes:${VIOLATIONS}"
            echo "violations=true" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          echo "All changes are within ${ALLOWED} — OK"

      - name: Close invalid PR
        if: failure() && steps.validate.outputs.violations == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO: ${{ github.repository }}
        run: |
          gh pr close "$PR_NUMBER" -R "$REPO" \
            -c "❌ PR 已自动关闭：@${PR_AUTHOR} 你只能修改 contributors/${PR_AUTHOR}/ 目录下的文件。请移除越权修改后重新提交。"
