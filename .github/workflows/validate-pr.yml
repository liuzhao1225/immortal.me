name: Validate PR

on:
  pull_request_target:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-permission:
    runs-on: ubuntu-latest
    steps:
      - name: Validate changed files
        id: validate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO_OWNER: ${{ github.repository_owner }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          if [ "$PR_AUTHOR" = "$REPO_OWNER" ]; then
            echo "Repo owner (${PR_AUTHOR}) — skip check"
            exit 0
          fi

          CHANGED=$(gh pr diff "$PR_NUMBER" -R "$REPO" --name-only)

          echo "PR author: ${PR_AUTHOR}"
          echo "Changed files:"
          echo "${CHANGED}"

          TOUCHED_OTHERS=""
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            if [[ "$file" == contributors/* && "$file" != contributors/${PR_AUTHOR}/* ]]; then
              TOUCHED_OTHERS="${TOUCHED_OTHERS}\n  - ${file}"
            fi
          done <<< "$CHANGED"

          if [ -n "$TOUCHED_OTHERS" ]; then
            echo "::error::You cannot modify other contributors' directories"
            echo -e "Unauthorized changes:${TOUCHED_OTHERS}"
            echo "touched_others=true" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          echo "No unauthorized changes — OK"

      - name: Close invalid PR
        if: failure() && steps.validate.outputs.touched_others == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO: ${{ github.repository }}
        run: |
          gh pr close "$PR_NUMBER" -R "$REPO" \
            -c "❌ PR 已自动关闭：@${PR_AUTHOR} 你不能修改其他贡献者的目录。请移除对他人目录的修改后重新提交。"
